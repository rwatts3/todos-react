{"version":3,"sources":["meteor://ðŸ’»app/packages/factory/factory.js","meteor://ðŸ’»app/packages/factory/dataset.js","meteor://ðŸ’»app/packages/factory/factory-api.js"],"names":[],"mappings":"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","file":"/packages/factory.js","sourcesContent":["/* global Factory:true */\r\n/* global LocalCollection */\r\n\r\nFactory = function(name, collection, properties) {\r\n  this.name = name;\r\n  this.collection = collection;\r\n  this.properties = properties;\r\n  this.afterBuildCbs = [];\r\n};\r\n\r\nFactory.prototype.afterBuild = function(cb) {\r\n  this.afterBuildCbs.push(cb);\r\n};\r\n\r\nFactory.prototype.build = function(dataset, props, opts) {\r\n  // favour passed in properties to defined properties\r\n  const properties = _.extend({}, this.properties, props);\r\n  const options = opts || {};\r\n\r\n  const doc = {};\r\n  const setProp = function(subDoc, prop, value) {\r\n    if (_.isFunction(value)) {\r\n      setProp(subDoc, prop, value.call(doc, dataset));\r\n    } else if (value instanceof Factory) {\r\n      if (options.noRelations) {\r\n        setProp(subDoc, prop, Random.id());\r\n      } else {\r\n        const relation = value.build(dataset);\r\n        setProp(subDoc, prop, relation._id);\r\n      }\r\n    // TODO:50 what is the correct check here?\r\n    } else if (_.isObject(value) && !_.isDate(value) && !_.isArray(value)) {\r\n      subDoc[prop] = subDoc[prop] || {};\r\n      walk(subDoc[prop], value);  // eslint-disable-line\r\n    } else if (prop !== '_id') {\r\n      const modifier = {$set: {}};\r\n      modifier.$set[prop] = value;\r\n      LocalCollection._modify(subDoc, modifier);\r\n    }\r\n  };\r\n\r\n  // walk the tree and evaluate\r\n  function walk(subDoc, subProps) {\r\n    _.each(subProps, function(value, prop) {\r\n      setProp(subDoc, prop, value);\r\n    });\r\n  }\r\n\r\n  // you can't set _id with _modify\r\n  if (properties._id) {\r\n    let id = properties._id;\r\n    if (_.isFunction(id)) {\r\n      id = id.call(doc);\r\n    }\r\n    doc._id = id;\r\n  } else {\r\n    doc._id = Random.id();\r\n  }\r\n\r\n  walk(doc, properties);\r\n\r\n  _.each(this.afterBuildCbs, function(callback) {\r\n    callback(doc, dataset);\r\n  });\r\n\r\n  dataset.addDocument(doc, this.collection);\r\n  return doc;\r\n};\r\n","/* global Factory */\r\n\r\nfunction Dataset() {\r\n  this.documents = {};\r\n  this.collections = {};\r\n}\r\n\r\n_.extend(Dataset.prototype, {\r\n  add(nameOrFactory, properties, opts) {\r\n    const options = opts || {};\r\n\r\n    let factory;\r\n    if (_.isString(nameOrFactory)) {\r\n      factory = Factory.get(nameOrFactory);\r\n    } else {\r\n      factory = nameOrFactory;\r\n    }\r\n\r\n    let doc = factory.build(this, properties, _.pick(options || {}, 'noRelations'));\r\n    if (options && options.target) {\r\n      // We need to apply the transform from the collection as we aren't inserting anywhere\r\n      if (factory.collection._transform) {\r\n        doc = factory.collection._transform(doc);\r\n      }\r\n\r\n      this.targetDocId = doc._id;\r\n      this.targetDocCollection = factory.collection;\r\n    }\r\n    return doc;\r\n  },\r\n\r\n  addDocument(document, collection) {\r\n    const collectionName = collection._name;\r\n\r\n    if (!this.documents[collectionName]) {\r\n      this.documents[collectionName] = [];\r\n      this.collections[collectionName] = collection;\r\n    }\r\n\r\n    this.documents[collectionName].push(document);\r\n  },\r\n\r\n  createAll() {\r\n    const self = this;\r\n\r\n    _.each(self.documents, function(docs, collectionName) {\r\n      _.each(docs, function(doc) {\r\n        self.collections[collectionName].insert(doc);\r\n      });\r\n    });\r\n  },\r\n\r\n  get(collectionName, id) {\r\n    // XXX:70 this could be a lot more efficient if we used a collection from the beginning\r\n    const doc = _.find(this.documents[collectionName], function(d) { return d._id === id; });\r\n    const transform = this.collections[collectionName]._transform;\r\n    if (transform) {\r\n      return transform(doc);\r\n    }\r\n    return doc;\r\n  },\r\n\r\n  getTargetDoc() {\r\n    return this.get(this.targetDocCollection._name, this.targetDocId);\r\n  },\r\n\r\n  getAsCollection(collectionName) {\r\n    // NOTE: this should be something more featured like StubCollections.stubCollection\r\n    //  as it should clone the schema etc also. Maybe it doesn't matter...\r\n    const collection = new Mongo.Collection(null, {\r\n      transform: this.collections[collectionName]._transform\r\n    });\r\n\r\n    _.each(this.documents[collectionName], function(doc) {\r\n      collection.insert(doc);\r\n    });\r\n\r\n    return collection;\r\n  },\r\n\r\n  getAsCursor(collectionName) {\r\n    const collection = this.getAsCollection(collectionName);\r\n    return collection.find();\r\n  }\r\n});\r\n\r\nFactory.Dataset = Dataset;\r\n","/* global Factory */\r\n\r\nFactory._factories = {};\r\n\r\nFactory.get = function(name) {\r\n  const factory = Factory._factories[name];\r\n  if (!factory) {\r\n    throw new Meteor.Error(`No factory defined named ${name}`);\r\n  }\r\n  return factory;\r\n};\r\n\r\nFactory.define = function(name, collection, properties) {\r\n  Factory._factories[name] = new Factory(name, collection, properties);\r\n  return Factory.get(name);\r\n};\r\n\r\n\r\nFactory.create = function(name, properties) {\r\n  const dataset = Factory.compile(name, properties);\r\n  dataset.createAll();\r\n  return dataset.targetDocCollection.findOne(dataset.targetDocId);\r\n};\r\n\r\nFactory.compile = function(name, properties, options) {\r\n  const dataset = new Factory.Dataset();\r\n  const factory = Factory.get(name);\r\n  dataset.add(factory, properties, _.extend({target: true}, options));\r\n  return dataset;\r\n};\r\n\r\nFactory.build = function(name, properties) {\r\n  const dataset = Factory.compile(name, properties, {noRelations: true});\r\n  return dataset.getTargetDoc();\r\n};\r\n\r\nFactory.extend = function(name, properties) {\r\n  return _.extend({}, Factory.get(name).properties, properties || {});\r\n};\r\n"]}