{"version":3,"sources":["meteor://ðŸ’»app/packages/publication-collector/publication-collector.js"],"names":[],"mappings":"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","file":"/packages/publication-collector.js","sourcesContent":["/* global PublicationCollector:true */\r\n\r\nconst EventEmitter = Npm.require(\"events\").EventEmitter;\r\n\r\n// This file describes something like Subscription in\r\n// meteor/meteor/packages/ddp/livedata_server.js, but instead of sending\r\n// over a socket it just collects data\r\nPublicationCollector = function(options = {}) {\r\n  // Object where the keys are collection names, and then the keys are _ids\r\n  this.responseData = {};\r\n\r\n  this.userId = options.userId;\r\n};\r\n\r\n// So that we can listen to ready event in a reasonable way\r\nMeteor._inherits(PublicationCollector, EventEmitter);\r\n\r\n_.extend(PublicationCollector.prototype, {\r\n  collect(name, ...args) {\r\n    if (_.isFunction(args[args.length - 1])) {\r\n      this.on('ready', args.pop());\r\n    }\r\n\r\n    const handler = Meteor.server.publish_handlers[name];\r\n    const result = handler.call(this, ...args);\r\n\r\n    // TODO:20 -- we should check that result has _publishCursor? What does _runHandler do?\r\n    if (result) {\r\n      // array-ize\r\n      [].concat(result).forEach(cur => cur._publishCursor(this));\r\n      this.ready();\r\n    }\r\n  },\r\n  added(collection, id, fields) {\r\n    check(collection, String);\r\n    check(id, String);\r\n\r\n    this._ensureCollectionInRes(collection);\r\n\r\n    // Make sure to ignore the _id in fields\r\n    const addedDocument = _.extend({_id: id}, _.omit(fields, \"_id\"));\r\n    this.responseData[collection][id] = addedDocument;\r\n  },\r\n  changed(collection, id, fields) {\r\n    check(collection, String);\r\n    check(id, String);\r\n\r\n    this._ensureCollectionInRes(collection);\r\n\r\n    const existingDocument = this.responseData[collection][id];\r\n    const fieldsNoId = _.omit(fields, \"_id\");\r\n    _.extend(existingDocument, fieldsNoId);\r\n\r\n    // Delete all keys that were undefined in fields (except _id)\r\n    _.forEach(fields, (value, key) => {\r\n      if (value === undefined) {\r\n        delete existingDocument[key];\r\n      }\r\n    });\r\n  },\r\n  removed(collection, id) {\r\n    check(collection, String);\r\n    check(id, String);\r\n\r\n    this._ensureCollectionInRes(collection);\r\n\r\n    delete this.responseData[collection][id];\r\n\r\n    if (_.isEmpty(this.responseData[collection])) {\r\n      delete this.responseData[collection];\r\n    }\r\n  },\r\n  ready() {\r\n    this.emit('ready', this._generateResponse());\r\n  },\r\n  onStop() {\r\n    // no-op in HTTP\r\n  },\r\n  error(error) {\r\n    throw error;\r\n  },\r\n  _ensureCollectionInRes(collection) {\r\n    this.responseData[collection] = this.responseData[collection] || {};\r\n  },\r\n  _generateResponse() {\r\n    const output = {};\r\n\r\n    _.forEach(this.responseData, (documents, collectionName) => {\r\n      output[collectionName] = _.values(documents);\r\n    });\r\n\r\n    return output;\r\n  }\r\n});\r\n"]}